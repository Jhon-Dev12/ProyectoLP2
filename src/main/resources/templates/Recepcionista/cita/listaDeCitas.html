<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Recepcionista/recepcionistaLayout}"> 

<head>
    <title>Lista de Citas</title>
</head>

<body>

<main class="container mt-4" layout:fragment="contenido">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Listado de Citas</h2>
        <!-- Botón para registrar nueva cita -->
        <a th:href="@{/recepcionista/cita/registrar}" class="btn btn-success">Registrar Cita</a>
    </div>

    <!-- Formulario de búsqueda -->
    <form th:action="@{/recepcionista/cita/listar}" method="get" class="mb-3">
        <div class="input-group">
            <input type="text" name="texto" class="form-control" placeholder="Buscar por nombre o apellido"
                   th:value="${texto}">
            <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
    </form>

    <!-- Tabla de citas -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Paciente</th>
                    <th>Médico</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Motivo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="cita : ${citas}">
                    <td th:text="${cita.paciente.nombre + ' ' + cita.paciente.apellido}">Paciente</td>
                    <td th:text="${cita.medico.nombres + ' ' + cita.medico.apellidos}">Médico</td>
                    <td th:text="${#temporals.format(cita.fecha, 'dd/MM/yyyy')}">Fecha</td>
                    <td th:text="${#temporals.format(cita.hora, 'HH:mm')}">Hora</td>
                    <td th:text="${cita.motivo}">Motivo</td>
                    <td>
                        <span th:text="${cita.estado}"
                              th:classappend="${cita.estado.name == 'PAGADO'} ? 'badge bg-success' :
                                              (cita.estado.name == 'PENDIENTE' ? 'badge bg-warning text-dark' :
                                              'badge bg-secondary')">
                        </span>
                    </td>
                    <td>
                        <!-- Botón Editar habilitado solo si NO está pagado -->
                        <a th:if="${cita.estado.name != 'PAGADO'}"
                           th:href="@{/recepcionista/cita/editar/{id}(id=${cita.idCita})}"
                           class="btn btn-warning btn-sm me-1">
                            Editar
                        </a>

                        <!-- Botón Editar deshabilitado si está pagado -->
                        <button th:if="${cita.estado.name == 'PAGADO'}"
                                class="btn btn-warning btn-sm me-1" disabled>
                            Editar
                        </button>

                        <!-- Botón Eliminar habilitado solo si NO está pagado -->
                        <form th:if="${cita.estado.name != 'PAGADO'}"
                              th:action="@{/recepcionista/cita/eliminar/{id}(id=${cita.idCita})}"
                              method="get"
                              style="display:inline;">
                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    th:onclick="|confirmarEliminar('${cita.idCita}')|">
                                Eliminar
                            </button>
                        </form>

                        <!-- Botón Eliminar deshabilitado si está pagado -->
                        <button th:if="${cita.estado.name == 'PAGADO'}"
                                class="btn btn-danger btn-sm" disabled>
                            Eliminar
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</main>

<th:block layout:fragment="scripts">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        let success = /*[[${success}]]*/ null;
        let error = /*[[${error}]]*/ null;
        let abrirModal = /*[[${abrirModal}]]*/ false;

        if (success) Swal.fire("Éxito", success, "success");
        if (error) Swal.fire("Error", error, "error");
    </script>

	<script>
	function confirmarEliminar(id) {
	    Swal.fire({
	        title: "¿Estás seguro?",
	        text: "Esta acción no se puede deshacer.",
	        icon: "warning",
	        showCancelButton: true,
	        confirmButtonColor: "#d33",
	        cancelButtonColor: "#3085d6",
	        confirmButtonText: "Sí, eliminar",
	        cancelButtonText: "Cancelar"
	    }).then((result) => {
	        if (result.isConfirmed) {
	            // Buscar el formulario del id y enviarlo
	            const form = document.querySelector(`form[action*='${id}']`);
	            if (form) form.submit();
	        }
	    });
	}
	</script>

</th:block>

</body>
</html>
