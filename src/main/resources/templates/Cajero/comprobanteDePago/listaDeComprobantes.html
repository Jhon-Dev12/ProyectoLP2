<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Cajero/cajeroLayout}">
<head>
    <title>Lista de Comprobantes de Pago</title>
</head>
<body>

<main class="container mt-4" layout:fragment="contenido">

    <h2 class="mb-4">Lista de Comprobantes de Pago</h2>
	<!-- Botón Registrar Comprobante -->
	<a th:href="@{/cajero/comprobanteDePago/registrar}" class="btn btn-primary">
	    Registrar Comprobante de Pago
	</a>

    <form th:action="@{/cajero/comprobanteDePago/listar}" method="get" class="mb-3 d-flex">
        <input type="text" name="texto" class="form-control me-2" placeholder="Buscar por DNI, nombre o apellido"
               th:value="${texto}">
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Pagador</th>
                    <th>DNI Pagador</th>
                    <th>Paciente</th>
                    <th>Fecha de Emisión</th>
                    <th>Monto</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="comprobante : ${comprobantes}">
                    <td th:text="${comprobante.idComprobante}">1</td>
                    <td th:text="${comprobante.nombrePagador + ' ' + comprobante.apellidosPagador}">Juan Pérez</td>
                    <td th:text="${comprobante.dniPagador}">12345678</td>
                    <td th:text="${comprobante.cita.paciente.nombre + ' ' + comprobante.cita.paciente.apellido}">Paciente Ejemplo</td>
                    <td th:text="${#temporals.format(comprobante.fechaEmision, 'dd/MM/yyyy HH:mm')}">23/10/2025 14:30</td>
                    <td th:text="${#numbers.formatDecimal(comprobante.monto, 1, 2)}">150.00</td>
                    <td>
                        <span th:text="${comprobante.estado}"
                              th:classappend="${comprobante.estado == 'ANULADO'} ? 'badge bg-danger' : 'badge bg-success'">
                            EMITIDO
                        </span>
                    </td>
					
					<td>
					    <!-- Botón Ver Detalle -->
					    <a th:href="@{/cajero/comprobanteDePago/detalle/{id}(id=${comprobante.idComprobante})}" 
					       class="btn btn-sm btn-info me-1">
					        Ver Detalle
					    </a>

					    <!-- Botón Anular con SweetAlert2 -->
					    <button th:if="${comprobante.estado.name != 'ANULADO' and comprobante.cita.estado.name != 'ATENDIDO'}"
					            type="button"
					            class="btn btn-warning btn-sm me-1"
					            th:data-id="${comprobante.idComprobante}"
					            onclick="confirmarAnular(this)">
					        Anular
					    </button>

					    <!-- Botón bloqueado si ya está anulado o la cita ya fue atendida -->
					    <button th:if="${comprobante.estado.name == 'ANULADO' or comprobante.cita.estado.name == 'ATENDIDO'}"
					            type="button"
					            class="btn btn-warning btn-sm me-1" disabled>
					        Anular
					    </button>
					</td>


                </tr>
                <tr th:if="${#lists.isEmpty(comprobantes)}">
                    <td colspan="8" class="text-center">No se encontraron comprobantes</td>
                </tr>
            </tbody>
        </table>
    </div>

</main>

<th:block layout:fragment="scripts">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
	    function confirmarAnular(btn) {
	        const id = btn.getAttribute('data-id');
	        Swal.fire({
	            title: '¿Está seguro?',
	            text: "No podrá revertir esta acción.",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: 'Sí, anular',
	            cancelButtonText: 'Cancelar'
	        }).then((result) => {
	            if (result.isConfirmed) {
	                // Redirige al endpoint de anulación
	                window.location.href = `/cajero/comprobanteDePago/anular?id=${id}`;
	            }
	        });
	    }
	</script>
</th:block>

</body>
</html>
